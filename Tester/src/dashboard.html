<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRAtix — Hosting Capability Tester</title>
<style>
  :root {
    --bg: #0b0e14;
    --surface: #131720;
    --surface2: #1a1f2e;
    --border: #252b3b;
    --text: #e1e4ea;
    --text2: #8b92a5;
    --accent: #6c5ce7;
    --accent2: #a29bfe;
    --green: #00e676;
    --green-bg: rgba(0,230,118,0.08);
    --red: #ff5252;
    --red-bg: rgba(255,82,82,0.08);
    --yellow: #ffd740;
    --yellow-bg: rgba(255,215,64,0.08);
    --blue: #448aff;
    --blue-bg: rgba(68,138,255,0.08);
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }
  .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border);
  }
  .header h1 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 4px;
  }
  .header .sub { color: var(--text2); font-size: 14px; }

  /* System Info */
  .sys-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 32px;
  }
  .sys-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
  }
  .sys-card .label { font-size: 11px; text-transform: uppercase; color: var(--text2); letter-spacing: 0.5px; }
  .sys-card .value { font-size: 18px; font-weight: 600; margin-top: 4px; font-variant-numeric: tabular-nums; }

  /* Controls */
  .controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .controls h2 { font-size: 20px; font-weight: 600; }
  .btn {
    background: var(--accent);
    border: none;
    color: #fff;
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-sm {
    padding: 6px 14px;
    font-size: 12px;
  }

  /* Summary bar */
  .summary-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .summary-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 500;
  }
  .summary-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  /* Test Cards */
  .category-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin: 24px 0 12px;
    padding-left: 4px;
  }
  .test-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }
  .test-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    display: flex;
    align-items: flex-start;
    gap: 14px;
    transition: border-color 0.15s;
    cursor: pointer;
  }
  .test-card:hover { border-color: var(--accent); }
  .test-card.expanded .details { display: block; }
  .status-badge {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    margin-top: 2px;
  }
  .status-pass { background: var(--green-bg); color: var(--green); }
  .status-fail { background: var(--red-bg); color: var(--red); }
  .status-warning { background: var(--yellow-bg); color: var(--yellow); }
  .status-skip { background: var(--blue-bg); color: var(--blue); }
  .status-error { background: var(--red-bg); color: var(--red); }
  .status-pending { background: var(--surface2); color: var(--text2); }

  .test-body { flex: 1; min-width: 0; }
  .test-name { font-size: 15px; font-weight: 600; }
  .test-msg { font-size: 13px; color: var(--text2); margin-top: 2px; }
  .test-duration { font-size: 11px; color: var(--text2); margin-top: 4px; font-variant-numeric: tabular-nums; }
  .details {
    display: none;
    margin-top: 12px;
    padding: 12px;
    background: var(--bg);
    border-radius: 8px;
    font-size: 12px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text2);
    max-height: 300px;
    overflow-y: auto;
  }

  /* Client-side tests panel */
  .client-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  .client-panel h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; }
  .client-test-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .client-test-row:last-child { border-bottom: none; }
  .client-status {
    font-size: 12px;
    font-weight: 600;
    padding: 2px 10px;
    border-radius: 4px;
    min-width: 70px;
    text-align: center;
  }

  /* Loading */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top: 2px solid var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { color: var(--text2); font-size: 14px; padding: 40px 0; text-align: center; }

  /* Footer */
  .footer {
    text-align: center;
    padding: 24px 0;
    color: var(--text2);
    font-size: 12px;
    border-top: 1px solid var(--border);
    margin-top: 40px;
  }

  @media (max-width: 640px) {
    .sys-grid { grid-template-columns: repeat(2, 1fr); }
    .container { padding: 16px; }
    .header h1 { font-size: 22px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>SRAtix Hosting Capability Tester</h1>
    <div class="sub">Probing server environment for SRAtix platform requirements</div>
  </div>

  <div id="sys-info" class="sys-grid">
    <div class="sys-card"><div class="label">Loading...</div><div class="value">—</div></div>
  </div>

  <div class="controls">
    <h2>Capability Tests</h2>
    <button class="btn" id="btn-run" onclick="runTests()">Run All Tests</button>
  </div>

  <div id="summary-bar" class="summary-bar" style="display:none;"></div>
  <div id="results">
    <div class="loading-text">Click "Run All Tests" to begin environment analysis</div>
  </div>

  <div class="category-label" style="margin-top:32px;">Client-Side Connection Tests</div>
  <div class="client-panel">
    <h3>WebSocket & SSE (tested from your browser)</h3>
    <div class="client-test-row">
      <span class="test-name" style="flex:1;">WebSocket Upgrade</span>
      <span id="ws-status" class="client-status" style="background:var(--surface2);color:var(--text2);">Pending</span>
      <button class="btn btn-sm" onclick="testWebSocket()">Test</button>
    </div>
    <div class="client-test-row">
      <span class="test-name" style="flex:1;">Server-Sent Events (SSE)</span>
      <span id="sse-status" class="client-status" style="background:var(--surface2);color:var(--text2);">Pending</span>
      <button class="btn btn-sm" onclick="testSSE()">Test</button>
    </div>
    <div id="client-details" style="margin-top:12px;"></div>
  </div>

  <div class="footer">
    SRAtix — Swiss Robotics Association &middot; TAROS Web Services
  </div>
</div>

<script>
// ─── System Info ────────────────────────────────────────────
async function loadInfo() {
  try {
    const res = await fetch('/api/info');
    const info = await res.json();
    const cards = [
      { label: 'Node.js', value: info.node },
      { label: 'Platform', value: `${info.platform} ${info.arch}` },
      { label: 'CPUs', value: info.cpus },
      { label: 'Memory', value: `${info.total_memory_mb} MB` },
      { label: 'Heap Used', value: `${info.heap_used_mb} MB` },
      { label: 'Uptime', value: `${info.uptime_seconds}s` },
      { label: 'PID', value: info.pid },
      { label: 'Heartbeats', value: info.heartbeats },
    ];
    document.getElementById('sys-info').innerHTML = cards.map(c =>
      `<div class="sys-card"><div class="label">${c.label}</div><div class="value">${c.value}</div></div>`
    ).join('');
  } catch (err) {
    document.getElementById('sys-info').innerHTML =
      `<div class="sys-card"><div class="label">Error</div><div class="value">${err.message}</div></div>`;
  }
}

// ─── Run Tests ──────────────────────────────────────────────
async function runTests() {
  const btn = document.getElementById('btn-run');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Running...';
  document.getElementById('results').innerHTML = '<div class="loading-text"><span class="spinner"></span> Running capability tests — this may take up to 30 seconds...</div>';
  document.getElementById('summary-bar').style.display = 'none';

  try {
    const res = await fetch('/api/tests');
    const data = await res.json();
    renderResults(data);
  } catch (err) {
    document.getElementById('results').innerHTML =
      `<div class="loading-text" style="color:var(--red);">Error: ${err.message}</div>`;
  }

  btn.disabled = false;
  btn.textContent = 'Run All Tests';
  loadInfo(); // refresh system info
}

function renderResults(data) {
  const { summary, results } = data;

  // Summary bar
  const sb = document.getElementById('summary-bar');
  sb.style.display = 'flex';
  sb.innerHTML = `
    <div class="summary-item"><span class="summary-dot" style="background:var(--green)"></span>${summary.pass} Passed</div>
    <div class="summary-item"><span class="summary-dot" style="background:var(--red)"></span>${summary.fail} Failed</div>
    <div class="summary-item"><span class="summary-dot" style="background:var(--yellow)"></span>${summary.warning} Warnings</div>
    <div class="summary-item"><span class="summary-dot" style="background:var(--blue)"></span>${summary.skip} Skipped</div>
    ${summary.error ? `<div class="summary-item"><span class="summary-dot" style="background:var(--red)"></span>${summary.error} Errors</div>` : ''}
  `;

  // Group by category
  const cats = {};
  for (const r of results) {
    const cat = r.category || 'other';
    if (!cats[cat]) cats[cat] = [];
    cats[cat].push(r);
  }

  const catLabels = {
    core: 'Core Runtime',
    network: 'Network & Connectivity',
    services: 'External Services',
    heavy: 'Heavy Operations',
    runtime: 'Process Runtime',
  };

  let html = '';
  for (const [cat, tests] of Object.entries(cats)) {
    html += `<div class="category-label">${catLabels[cat] || cat}</div>`;
    html += '<div class="test-grid">';
    for (const t of tests) {
      const icon = { pass: '✓', fail: '✗', warning: '!', skip: '–', error: '✗' }[t.status] || '?';
      const autoExpand = (t.status === 'fail' || t.status === 'error') && t.details;
      html += `
        <div class="test-card${autoExpand ? ' expanded' : ''}" onclick="this.classList.toggle('expanded')">
          <div class="status-badge status-${t.status}">${icon}</div>
          <div class="test-body">
            <div class="test-name">${esc(t.name)}</div>
            <div class="test-msg">${esc(t.message)}</div>
            <div class="test-duration">${t.duration_ms}ms</div>
            ${t.details ? `<div class="details">${esc(JSON.stringify(t.details, null, 2))}</div>` : ''}
          </div>
        </div>
      `;
    }
    html += '</div>';
  }

  document.getElementById('results').innerHTML = html;
}

// ─── WebSocket Test ─────────────────────────────────────────
function testWebSocket() {
  const el = document.getElementById('ws-status');
  el.textContent = 'Testing...';
  el.style.background = 'var(--surface2)';
  el.style.color = 'var(--text2)';

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url = `${proto}//${location.host}`;

  try {
    const ws = new WebSocket(url);
    const timeout = setTimeout(() => {
      ws.close();
      el.textContent = 'Timeout';
      el.style.background = 'var(--red-bg)';
      el.style.color = 'var(--red)';
    }, 6000);

    ws.onopen = () => {
      ws.send('SRAtix ping');
    };

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.type === 'echo' || data.type === 'connected') {
        clearTimeout(timeout);
        el.textContent = 'PASS';
        el.style.background = 'var(--green-bg)';
        el.style.color = 'var(--green)';
        addClientDetail('WebSocket', `Connected! Server responded: ${data.message || data.original}`);
        // Keep connection open briefly to test persistence, then close
        setTimeout(() => ws.close(), 1000);
      }
    };

    ws.onerror = () => {
      clearTimeout(timeout);
      el.textContent = 'FAIL';
      el.style.background = 'var(--red-bg)';
      el.style.color = 'var(--red)';
      addClientDetail('WebSocket', 'Connection failed — WebSocket upgrade may not be supported by hosting/proxy');
    };

    ws.onclose = (e) => {
      if (el.textContent === 'Testing...') {
        clearTimeout(timeout);
        el.textContent = 'FAIL';
        el.style.background = 'var(--red-bg)';
        el.style.color = 'var(--red)';
        addClientDetail('WebSocket', `Connection closed prematurely: code=${e.code} reason=${e.reason || 'none'}`);
      }
    };
  } catch (err) {
    el.textContent = 'ERROR';
    el.style.background = 'var(--red-bg)';
    el.style.color = 'var(--red)';
    addClientDetail('WebSocket', err.message);
  }
}

// ─── SSE Test ───────────────────────────────────────────────
function testSSE() {
  const el = document.getElementById('sse-status');
  el.textContent = 'Testing...';
  el.style.background = 'var(--surface2)';
  el.style.color = 'var(--text2)';

  try {
    const es = new EventSource('/api/sse-stream');
    let received = 0;
    const timeout = setTimeout(() => {
      es.close();
      if (received === 0) {
        el.textContent = 'Timeout';
        el.style.background = 'var(--red-bg)';
        el.style.color = 'var(--red)';
      }
    }, 10000);

    es.onmessage = (e) => {
      received++;
      const data = JSON.parse(e.data);
      if (received === 1) {
        addClientDetail('SSE', `Receiving events... (${data.count}/5)`);
      }
    };

    es.addEventListener('done', () => {
      clearTimeout(timeout);
      es.close();
      el.textContent = `PASS`;
      el.style.background = 'var(--green-bg)';
      el.style.color = 'var(--green)';
      addClientDetail('SSE', `All ${received} events received successfully`);
    });

    es.onerror = () => {
      // EventSource reconnects on error; if we got events, it might just be the stream ending
      if (received >= 5) {
        clearTimeout(timeout);
        es.close();
        el.textContent = 'PASS';
        el.style.background = 'var(--green-bg)';
        el.style.color = 'var(--green)';
      } else if (received === 0) {
        clearTimeout(timeout);
        es.close();
        el.textContent = 'FAIL';
        el.style.background = 'var(--red-bg)';
        el.style.color = 'var(--red)';
        addClientDetail('SSE', 'SSE connection failed — server may not support streaming responses');
      }
    };
  } catch (err) {
    el.textContent = 'ERROR';
    el.style.background = 'var(--red-bg)';
    el.style.color = 'var(--red)';
    addClientDetail('SSE', err.message);
  }
}

// ─── Helpers ────────────────────────────────────────────────
function addClientDetail(testName, msg) {
  const el = document.getElementById('client-details');
  const line = document.createElement('div');
  line.style.cssText = 'font-size:12px;color:var(--text2);padding:4px 0;font-family:monospace;';
  line.textContent = `[${testName}] ${msg}`;
  el.appendChild(line);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ─── Init ───────────────────────────────────────────────────
loadInfo();
setInterval(loadInfo, 10000); // refresh system info every 10s
</script>
</body>
</html>
